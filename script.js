// ========== GLOBALS ==========\n// ‚ö†Ô∏è Fallback Google Maps API key used when the server endpoint is unavailable.\n//    This allows the application to keep functioning when served statically\n//    (e.g., via GitHub Pages) where the Express backend isn't accessible.\n//    The value can still be overridden via window.GOOGLE_MAPS_API_KEY,\n//    a <meta name="google-maps-api-key"> tag, or the /api/maps-key endpoint.\nconst FALLBACK_GOOGLE_MAPS_API_KEY = "AIzaSyAMlrXwwsOWvNl7713bqYandeg77FGCte4";\n\nlet startCoords = null;\nlet destCoords = null;\nlet waypointCoords = [];\nlet markers = []; // all markers for cleanup\nlet map, geocoder, directionsService, directionsRenderer;\nlet lastCalculatedStops = []; // keep all overnight stop names in order\nlet chargerMarkers = [];\nlet calcSeq = 0; // guards against stale/overlapping CalculateLegs runs\n// üåç Distance unit preference\nlet distanceUnit = localStorage.getItem("distanceUnit") || "km";\n\n\n// === AFFILIATE SETTINGS ===\nconst AFFILIATES = {\n  booking: { id: 1234567 }, // üîÅ replace with your Booking.com affiliate ID\n  expedia: { id: 7654321 }  // üîÅ replace with your Expedia affiliate ID\n};\n\n\n// üåç Distance Conversion Helpers\nfunction kmToMi(km) {\n  return km * 0.621371;\n}\n\nfunction formatDistance(valueKm) {\n  // valueKm is always kilometers from our code\n  if (distanceUnit === "mi") {\n    const miles = valueKm * 0.621371;\n    return `${miles.toFixed(1)} mi`;\n  } else {\n    return `${valueKm.toFixed(1)} km`;\n  }\n}\n\n\n// üåÄ Loading spinner (fade-in/out)\nconst spinner = document.createElement("div");\nspinner.id = "loadingSpinner";\nObject.assign(spinner.style, {\n  position: "fixed",\n  top: "50%",\n  left: "50%",\n  transform: "translate(-50%, -50%)",\n  background: "rgba(0,0,0,0.75)",\n  color: "white",\n  padding: "20px 30px",\n  borderRadius: "12px",\n  fontSize: "16px",\n  letterSpacing: "0.5px",\n  boxShadow: "0 0 15px rgba(0,0,0,0.5)",\n  opacity: "0",\n  transition: "opacity 0.3s ease",\n  zIndex: "9999",\n  pointerEvents: "none"\n});\nspinner.innerText = "Calculating route...";\ndocument.body.appendChild(spinner);\n\n// ‚ú® Helper functions for fade effect\nfunction showSpinner() {\n  spinner.style.display = "block";\n  requestAnimationFrame(() => spinner.style.opacity = "1");\n}\n\nfunction hideSpinner() {\n  spinner.style.opacity = "0";\n  setTimeout(() => spinner.style.display = "none", 300);\n}\n\n\n// ========== LOAD SAVED TRIP (only when explicitly requested) ==========\nfunction loadSelectedTrip() {\n  const savedTrip = localStorage.getItem('tripToLoad');\n  if (!savedTrip) return; // nothing selected\n\n  const trip = JSON.parse(savedTrip);\n\n  // --- Restore basic trip fields ---\n  document.getElementById('starting').value = trip.start || '';\n  document.getElementById('destination').value = trip.destination || '';\n  document.getElementById('maxdaydistance').value = trip.maxDailyDistance || '';\n  document.getElementById('adults').value = trip.numAdults || 1;\n  document.getElementById('children').value = trip.numChildren || 0;\n\n  // --- Rebuild children ages dropdowns ---\n  updateChildrenAges();\n  if (trip.childrenAges) {\n    trip.childrenAges.forEach((age, i) => {\n      const select = document.getElementById(`childAge${i}`);\n      if (select) select.value = age;\n    });\n  }\n\n  // --- Restore stops ---\n  const stopsContainer = document.getElementById('stopsContainer');\n  stopsContainer.innerHTML = '';\n  waypointCoords = [];\n  (trip.stops || []).forEach(stop => {\n    // stop may be a string (old format) or an object { location, nights }\n    if (typeof stop === "string") {\n      addStop(stop);\n    } else if (stop.location) {\n      const stopDiv = addStop(stop.location);\n      const stayInput = stopDiv?.querySelector(".stay-input");\n      if (stayInput) stayInput.value = stop.nights || 1;\n    }\n  });\n\n  // --- Restore dates ---\n  if (trip.fromDate) document.getElementById('fromDate').value = trip.fromDate;\n  if (trip.toDate) document.getElementById('toDate').value = trip.toDate;\n\n  // --- Restore additional details ---\n  document.getElementById('rooms').value = trip.numRooms || 1;\n\n  // --- Restore distance unit FIRST ---\n  if (trip.distanceUnit) {\n    const unitSelect = document.getElementById('unitSelect');\n    if (unitSelect) {\n      unitSelect.value = trip.distanceUnit;\n      localStorage.setItem('distanceUnit', trip.distanceUnit);\n    }\n  }\n\n  // --- Update the fuel label dynamically based on restored unit ---\n  const fuelPriceLabel = document.querySelector('label[for="fuelPrice"]');\n  if (fuelPriceLabel) {\n    if (trip.distanceUnit === 'mi') {\n      fuelPriceLabel.innerText = 'Fuel Price ($/gal or kWh):';\n    } else {\n      fuelPriceLabel.innerText = 'Fuel Price ($/L or kWh):';\n    }\n  }\n\n  if (trip.vehicleType) document.getElementById('vehicleType').value = trip.vehicleType;\n  if (trip.fuelType) document.getElementById('fuelType').value = trip.fuelType;\n  if (trip.fuelPrice) document.getElementById('fuelPrice').value = trip.fuelPrice;\n\n  // --- Auto-calculate if requested ---\n  if (trip.autoCalc) {\n    setTimeout(() => CalculateLegs(), 500);\n  }\n\n  // ‚úÖ Remove flag after use so it won‚Äôt reload on next page open\n  localStorage.removeItem('tripToLoad');\n}\n\n// ‚úÖ DO NOT auto-run this on every load.\n// Instead, call loadSelectedTrip() *only* after the user clicks ‚ÄúView‚Äù on a saved trip.\n// The rest of the app (date + current location) auto-fills separately.\n\n\n// ========== MAP STYLES ==========
const darkMapStyle = [\n  { elementType: "geometry", stylers: [{ color: "#242f3e" }] },\n  { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },\n  { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },\n  { featureType: "administrative.locality", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },\n  { featureType: "poi", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },\n  { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#263c3f" }] },\n  { featureType: "poi.park", elementType: "labels.text.fill", stylers: [{ color: "#6b9a76" }] },\n  { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] },\n  { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#212a37" }] },\n  { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#9ca5b3" }] },\n  { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#746855" }] },\n  { featureType: "road.highway", elementType: "geometry.stroke", stylers: [{ color: "#1f2835" }] },\n  { featureType: "road.highway", elementType: "labels.text.fill", stylers: [{ color: "#f3d19c" }] },\n  { featureType: "transit", elementType: "geometry", stylers: [{ color: "#2f3948" }] },\n  { featureType: "transit.station", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },\n  { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] },\n  { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#515c6d" }] },\n  { featureType: "water", elementType: "labels.text.stroke", stylers: [{ color: "#17263c" }] }\n];\n\n// ========== INITIALIZE MAP + AUTOCOMPLETE ==========